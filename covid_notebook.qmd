---
title: "Mobilité en Wallonie avant et pendant la pandémie du Covid-19"
author: "Hocquet Anaïs, Lebourgeois Solène & Vanderhaegen Lucie"
format:
  html:
    code-fold: true
    code-tools: true
    toc: true
editor: visual
lang: fr
---

<!--# Ceci est un commentaire. -->

<!--% Ceci est une consigne. Ne jamais modifier ni déplacer les consignes dans le document ! -->

<!--% Complétez le titre et le nom des auteurs (auteur1, auteur2, auteur3 et auteur 4) dans l'entête YAML.-->

## Introduction et but

<!--% Rédigez une courte introduction de 3 ou 5 phrases qui présente vos données. Ajoutez une phrase de but. Vous devez citer la bibliographie en utilisant le formatage Markdown ad hoc et en incluant votre référence au format bibtex dans le fichier references.bib. -->

Lors de la pandémie Covid-2019, des mesures ont été prises sur les différentes habitudes de déplacement de la population. Ces données ont été récoltées en Belgique à partir du 15 février 2020 et jusqu'au 15 octobre 2022. Les milieux de fréquentation renseignés sont les lieux de loisirs, les commerces de détail, les commerces d'alimentation, les pharmacies, les parcs ainsi que les lieux de travail.

Dans ce rapport, nous allons donc comparer les séries concernant les lieux de travail, les x et y. Ces analyses permettront de mettre en évidence l'impact des restrictions sanitaires mises en place lors de la pandémie sur la fréquentation sur la fréquentation des différents lieux étudiés.

## Matériel et méthodes

<!--% Indiquez ici d'où viennent les données et aussi quel logiciel (et version) vous utilisez pour les analyses. Inspirez-vous des projets déjà réalisés. -->

Les données viennent de Datacovid qui vient de Google.

L'analyse est réalisée avec la [SciViews Box 2023](https://www.sciviews.org/software/svbox/) dans [Saturn Cloud](https://saturncloud.io) (Linux), utilisant le [logiciel R](https://www.r-project.org) (`r R.version.string`). Le package {pastecs} version `r packageVersion("pastecs")` est utilisé pour étudier la série temporelle.

## Analyses

<!--% Lisez bien les éléments devant guider votre analyse proposée dans le README.-->

```{r setup, include=FALSE}
# Nécessaire pour les tests SDD, ne pas utiliser dans un "vrai" projet
if (!"tools:tests" %in% search())
  source(here::here("tests/tools_tests.R"), attach(NULL, name = "tools:tests"))
# Configuration de l'environnement
SciViews::R("ts")
```

<!--% Ajoutez le nombre de chunks que vous souhaitez. Répartissez-vous le travail correctement. Structurez la section en partie avec des titres explicites de niveau trois.-->
```{r importation}
# Importation des données et descriptions de celles-ci avec représentation graphique
# Anaïs
covid <- read("data/mobility_wallonia.rds")
#Un remaniement des données est nécessaire pour renommer les variables de façon plus simple à utiliser
covid <- srename(covid, retail_and_recreation_percent_change_from_baseline = retail_recreation,
  grocery_and_pharmacy_percent_change_from_baseline = grocery_pharmacy,
  parks_percent_change_from_baseline = parks,
  transit_stations_percent_change_from_baseline = transit,
  workplaces_percent_change_from_baseline = workplaces,
  residential_percent_change_from_baseline = residential)
#visualisation des données telles quelles
skimr::skim(covid)
```
Notre jeu de données que nous nommons "covid" possède 974 observations pour 7 variables. Nous avons 1 observation par jour, du 15 février 2020 au 15 octobre 2022. Nous allons représenter ces données sous forme de série chronologique.

```{r ts}
# création de l'objet ts ou mts + vérification avec class() + visualisation des données
# Anaïs
covid_ts <- ts(covid, start = c(2020, 2, 15), frequency = 365)
plot(covid_ts)
# Copie de la série initiale sous une autre nom
mobw <- covid
# Calcul des jours de la semaine
mobw$weekdays <- weekdays(as.POSIXct(mobw$date))
# Les données du week-end sont remplacées par des valeurs manquantes
mobw[mobw$weekdays == "Saturday" | mobw$weekdays == "Sunday" , 2:7] <- NA 


```
Pour chaque variable, une série chronologique est créée. Au 0, c'est la valeur de départ, le déplacement "classique", normal, pas de déplacement supplémentaire ou moins de déplacement pour la raison de la variable. Quand la valeur est négative, le taux de déplacement est moindre comparé aux années d'avant "normales". Quand elle est positive, le déplacement est supérieur par rapport aux années d'avant.
Pour l'axe du temps, lorsque le temps s'affiche, par exemple, "2020.5", cela signifie que nous sommes à la moitié de l'année.
Au cas où, pour les futures analyses, les différentes séries ont également été scindées (au lieu d'avoir un seul objet mts avec toutes les séries comprises, il y aura différents objets de classe ts)
L'analyse est scindée, entre les weekends et les jours de la semaine.

```{r retail and recreation}
#Anaïs sur l'analyse des déplacements vers les magasins de détail et loisirs
# La série temporelle est créée (début le 15 février 2020 = 46e jour de l'année 2020)
mobw_ts <- ts(mobw$retail_recreation, start = c(2020, 46), frequency = 365)
plot(mobw_ts)
# Aggrégation par moyenne des valeurs par semaine
retail_recreation_ts <- aggregate(mobw_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(retail_recreation_ts, ylab = "Pourcentage de déplacement vers les magasins de détail et loisirs", xlab = "Temps")

```
Pour la première série choisie, nous prenons la variable retail_recreation. Cela correspond au taux de déplacement depuis la norme (0). Si la valeur est négative, il y a moins de déplacement vers les magasins de détail et loisirs. Si la valeur est positives, la population a eu tendance à davantage se déplacer vers ceux-ci. 
Ensuite, nous procédons à l'analyse de la série (dans ce même chunk pour un gain de place au sein du notebook, il se peut que ce soit mis différemment au niveau du report).

```{r ts_residential}
# Lucie sur la VAR = residential
# La série temporelle est créée (début le 15 février 2020 = 46e jour de l'année 2020) selon la variable residential
residential_ts <- ts(mobw$residential, start = c(2020, 46), frequency = 365)
plot(residential_ts)
# Aggrégation par moyenne des valeurs par semaine
residential_ts1 <- aggregate(residential_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(residential_ts1, ylab = "Pourcentage de déplacement vers les lieux de résidences")
```

```{r ts_workplaces}
# Solène sur la VAR = workplaces
# La série temporelle est créée (début le 15 février 2020 = 46e jour de l'année 2020) selon la variable worplaces
workplaces_ts <- ts(mobw$workplaces, start = c(2020, 46), frequency = 365)
plot(mobw_ts)
# Aggrégation par moyenne des valeurs par semaine
workplaces_ts2 <- aggregate(workplaces_ts, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(workplaces_ts2, ylab = "Pourcentage de déplacement vers les lieux de travails")
```

Pour workplace_ts, la ligne est très dentelée et irrégulière. Elle chute brutalement de 0 à -80 au début de 2020, puis remonte progressivement avec beaucoup de zigzags. Vers mi 2020, elle atteint des valeurs autour de 0 à +20. Elle redescend ensuite vers -40/-60 fin 2020 début 2021. Pour le reste de la période, la ligne oscille fortement entre -20 et +40 avec un aspect très chaotique et hérissé. En fin de période, les valeurs se situent entre +10 et +20.

Pour workplaces_ts2, la ligne est beaucoup plus lisse. Elle descend rapidement à -70 début 2020, puis forme un motif en "W" durant 2020. En 2021, elle oscille en vagues régulières entre -60 et -20. Durant 2022, elle continue ses ondulations mais remonte progressivement. En fin de période, elle approche de 0. L'ensemble est fluide et permet de voir clairement les tendances générales.

```{r worplace_analysis}
#Analyse de la fréquentation des lieux de travail
# L'objet workplaces_ts existe déjà, mais on le recrée ici pour clarté

workplaces_ts <- ts(mobw$workplaces, start = c(2020, 46), frequency = 365)

# Décomposition de la série: période comprenant les 2 confinements (du 18 mars 2020 au 9 juin 2021)

conf <- window(workplaces_ts, start = c(2020, 78), end = c(2021, 160))

# Décomposition de la série: période après les 2 confinements (du 9 juin 2021 à la fin de 2022)

after <- window(workplaces_ts, start = c(2021, 160), end = c(2022, 288))

# Agrégation dans le but de supprimer les NA, pour le jeu de données conf

conf_agr <- aggregate(conf, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(conf_agr, xlab = "Temps", ylab = "Variation dans la présence au travail (%)", main = "Période de confinement: Jours de la semaine agrégés")
abline(h = 0, col = "red", lty = 2)

acf(conf_agr, main = "ACF de la série ST confinement")

# Agrégation dans le but de supprimer les NA, pour le jeu de données after

after_agr <- aggregate(after, 52, FUN = collapse::fmean, ts.eps = 1/52)
plot(after_agr, xlab = "Temps", ylab = "Variation dans la présence au travail (%)", main = "Période post confinement: Jours de la semaine agrégés")
abline(h = 0, col = "red", lty = 2)

acf(after_agr, main = "ACF de la série ST post confinement")

# Tendance générale confinement
set.seed(21)
tt_conf <- trend.test(conf_agr, R = 999)
plot(tt_conf, main = "Tendance générale de la série ST confinement")

# Tendance locale confinement
lt_conf <- local.trend(conf_agr)
plot(lt_conf, main = "Tendances locales - Période de confinement")

# Tendance générale post confinement
set.seed(210)
tt_after <- trend.test(after_agr, R = 999)
plot(tt_after, main = "Tendance générale de la série ST Post confinement")

# Tendance locale post confinement
lt_after <- local.trend(after_agr)
plot(lt_after, main = "Tendances locales - Période post-confinement")

# Décomposition: période de confinement 1, période entre les deux confinements, et la deuxième période de confinement

conf1 <- window(workplaces_ts, start = c(2020, 78), end = c(2020, 167))
data.after <- window(workplaces_ts, start = c(2020, 167), end = c(2020, 307))
conf2 <- window(workplaces_ts, start = c(2020, 307), end = c(2021, 160))

conf1_agr <- aggregate(conf1, 52, FUN = collapse::fmean, ts.eps = 1/52)
data_after_agr <- aggregate(data.after, 52, FUN = collapse::fmean, ts.eps = 1/52)
conf2_agr <- aggregate(conf2, 52, FUN = collapse::fmean, ts.eps = 1/52)

plot(conf1_agr, xlab = "Temps", ylab = "Variation dans la présence au travail (%)", main = "Premier confinement")
abline(h = 0, col = "red", lty = 2)

plot(data_after_agr, xlab = "Temps", ylab = "Variation dans la présence au travail (%)", main = "Période pause entre les deux confinements")
abline(h = 0, col = "red", lty = 2)

plot(conf2_agr, xlab = "Temps", ylab = "Variation dans la présence au travail (%)", main = "Deuxième confinement")
abline(h = 0, col = "red", lty = 2)

```

Durant la période englobant les deux confinements, l'ensemble des graphiques (séries agrégées, ACF, tests de tendance et sous-périodes) révèle une diminution drastique de la fréquentation des lieux de travail avec une chute brutale atteignant -70% lors du premier confinement (mars-juin 2020), témoignant de l'obligation généralisée du télétravail.

Entre les deux confinements (juin-novembre 2020), bien qu'une récupération partielle soit observable avec des valeurs autour de -30%, la fréquentation reste systématiquement inférieure aux niveaux pré-COVID et à aucun moment la population n'a retrouvé une fréquentation équivalente à celle d'avant la pandémie.

Le deuxième confinement (novembre 2020-juin 2021) montre un impact moins sévère (-25 à -40%) avec des fluctuations importantes, et la tendance locale révèle une amélioration progressive suggérant une adaptation des entreprises avec la mise en place de protocoles sanitaires permettant un retour partiel au travail en présentiel.

Pour la période post-confinement (juin 2021-octobre 2022), les graphiques présentent des oscillations marquées entre -50% et +20%, avec une fréquentation restant très variable jusqu'à fin 2021 (autour de -40%) puis s'améliorant progressivement en 2022. Ces variations témoignent d'un changement structurel où le télétravail s'est normalisé et est devenu un choix organisationnel même après la levée des obligations sanitaires, les pics positifs en 2022 suggérant des périodes de "rattrapage" ou de retour au bureau encouragé par certaines entreprises.

Les tests acf montrent que la majorité des pics se situent à l'intérieur de l'enveloppe de confiance indiquant des autocorrélations non-significatives, et nous ne détectons pas de cycle saisonnier, ce qui est cohérent puisque la fréquentation des lieux de travail dépend des décisions politiques concernant les restrictions sanitaires plutôt que de patterns saisonniers prévisibles. Les tests de tendance confirment une amélioration significative durant la période de confinement avec une tendance positive, tandis que la période post-confinement montre une forte variabilité sans direction claire reflétant l'hétérogénéité des politiques d'entreprises concernant le travail hybride.

## Conclusion

<!--% Lorsque toutes les analyses sont réalisées, terminez ce bloc-notes avec 3 à 6 phrases de conclusion en rapport avec ce que vous avez observé dans vos analyses. Quels sont les éléments les plus pertinents que vous retenez ? -->

...vos conclusions ici...
